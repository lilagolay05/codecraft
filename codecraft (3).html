<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeCraft</title>
<link rel="icon" id="favicon" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --accent: #7c3aed;
    --accent2: #06b6d4;
    --accent3: #f59e0b;
    --success: #10b981;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --xp-color: #f59e0b;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid bg */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(124,58,237,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,58,237,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; display: flex; flex-direction: column; min-height: 100vh; }

  /* NAV */
  nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,10,15,0.9);
    backdrop-filter: blur(20px);
    position: sticky; top: 0; z-index: 100;
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 1.4rem; font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: -1px;
  }

  .logo span { -webkit-text-fill-color: var(--accent3); }

  .nav-stats { display: flex; gap: 20px; align-items: center; }

  .xp-badge {
    display: flex; align-items: center; gap: 6px;
    background: rgba(245,158,11,0.12);
    border: 1px solid rgba(245,158,11,0.3);
    padding: 6px 14px; border-radius: 20px;
    font-family: 'Space Mono', monospace;
    font-size: 0.85rem; font-weight: 700; color: var(--xp-color);
  }

  .streak-badge {
    display: flex; align-items: center; gap: 6px;
    background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3);
    padding: 6px 14px; border-radius: 20px;
    font-family: 'Space Mono', monospace;
    font-size: 0.85rem; color: #f87171;
  }

  .nav-tabs { display: flex; gap: 4px; }
  .nav-tab {
    padding: 8px 18px; border-radius: 8px; border: none;
    background: transparent; color: var(--muted); cursor: pointer;
    font-family: 'Syne', sans-serif; font-size: 0.9rem; font-weight: 600;
    transition: all 0.2s;
  }
  .nav-tab:hover { color: var(--text); background: var(--surface2); }
  .nav-tab.active { color: var(--text); background: var(--surface2); border: 1px solid var(--border); }

  /* MAIN LAYOUT */
  main { flex: 1; padding: 32px; max-width: 1400px; margin: 0 auto; width: 100%; }

  /* SECTIONS */
  .section { display: none; }
  .section.active { display: block; }

  /* HERO */
  .hero {
    text-align: center; padding: 60px 20px 40px;
  }
  .hero h1 {
    font-size: clamp(2.5rem, 6vw, 4.5rem); font-weight: 800;
    line-height: 1.05; margin-bottom: 16px;
  }
  .hero h1 em { font-style: normal; color: var(--accent2); }
  .hero p { color: var(--muted); font-size: 1.1rem; max-width: 500px; margin: 0 auto 32px; }

  .daily-gift-banner {
    display: inline-flex; align-items: center; gap: 12px;
    background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
    border: 1px solid rgba(245,158,11,0.4);
    padding: 14px 24px; border-radius: 16px;
    cursor: pointer; transition: all 0.3s;
    animation: glow 2s ease-in-out infinite alternate;
    margin-bottom: 48px;
  }
  .daily-gift-banner:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(245,158,11,0.2); }

  @keyframes glow {
    from { box-shadow: 0 0 10px rgba(245,158,11,0.1); }
    to { box-shadow: 0 0 25px rgba(245,158,11,0.3); }
  }

  .gift-icon { font-size: 1.8rem; animation: bounce 1s ease-in-out infinite; }
  @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

  .gift-text strong { display: block; color: var(--xp-color); font-weight: 700; }
  .gift-text small { color: var(--muted); font-size: 0.8rem; }

  /* PROGRESS BAR */
  .progress-section {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; margin-bottom: 32px;
  }
  .progress-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
  .level-label { font-weight: 700; font-size: 1rem; }
  .xp-label { font-family: 'Space Mono', monospace; font-size: 0.85rem; color: var(--muted); }
  .progress-bar-outer {
    height: 10px; background: var(--surface2); border-radius: 10px; overflow: hidden;
  }
  .progress-bar-inner {
    height: 100%; border-radius: 10px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  /* LESSONS GRID */
  .section-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 24px; }
  .section-title span { color: var(--accent2); }

  .lessons-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;
  }

  .lesson-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; cursor: pointer;
    transition: all 0.25s; position: relative; overflow: hidden;
  }
  .lesson-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    opacity: 0; transition: opacity 0.25s;
  }
  .lesson-card:hover { transform: translateY(-3px); border-color: var(--accent); }
  .lesson-card:hover::before { opacity: 1; background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .lesson-card.completed { border-color: rgba(16,185,129,0.3); }
  .lesson-card.completed::before { opacity: 1; background: var(--success); }
  .lesson-card.locked { opacity: 0.5; cursor: not-allowed; }
  .lesson-card.locked:hover { transform: none; border-color: var(--border); }

  .lesson-tag {
    font-size: 0.7rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
    padding: 3px 10px; border-radius: 20px; display: inline-block; margin-bottom: 12px;
  }
  .tag-js { background: rgba(245,158,11,0.15); color: var(--xp-color); }
  .tag-html { background: rgba(239,68,68,0.15); color: #f87171; }
  .tag-css { background: rgba(6,182,212,0.15); color: var(--accent2); }
  .tag-py { background: rgba(124,58,237,0.15); color: #a78bfa; }

  .lesson-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 6px; }
  .lesson-desc { font-size: 0.85rem; color: var(--muted); line-height: 1.5; margin-bottom: 16px; }
  .lesson-footer { display: flex; align-items: center; justify-content: space-between; }
  .lesson-xp {
    font-family: 'Space Mono', monospace; font-size: 0.8rem;
    color: var(--xp-color); font-weight: 700;
  }
  .lesson-status { font-size: 1rem; }
  .difficulty { font-size: 0.75rem; color: var(--muted); }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 24px; width: 90%; max-width: 700px;
    max-height: 85vh; overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  .modal-header {
    padding: 28px 28px 20px; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: flex-start;
  }
  .modal-body { padding: 28px; }

  .close-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); width: 36px; height: 36px; border-radius: 8px;
    cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .close-btn:hover { color: var(--text); }

  .lesson-content p { color: var(--muted); line-height: 1.7; margin-bottom: 16px; }
  .lesson-content h3 { font-weight: 700; margin-bottom: 8px; margin-top: 24px; color: var(--accent2); }

  .code-block {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px;
    font-family: 'Space Mono', monospace; font-size: 0.85rem;
    line-height: 1.7; color: #e2e8f0; margin: 16px 0;
    overflow-x: auto;
  }
  .code-block .kw { color: #c084fc; }
  .code-block .str { color: #86efac; }
  .code-block .fn { color: #67e8f9; }
  .code-block .cm { color: #4b5563; }
  .code-block .num { color: #fbbf24; }

  .challenge-box {
    background: rgba(124,58,237,0.05); border: 1px solid rgba(124,58,237,0.2);
    border-radius: 12px; padding: 20px; margin: 20px 0;
  }
  .challenge-box h4 { color: #a78bfa; font-weight: 700; margin-bottom: 8px; }

  .code-editor {
    width: 100%; min-height: 120px;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px;
    font-family: 'Space Mono', monospace; font-size: 0.85rem;
    color: var(--text); resize: vertical; outline: none;
    transition: border-color 0.2s;
    margin-top: 10px;
  }
  .code-editor:focus { border-color: var(--accent); }

  .btn {
    padding: 12px 24px; border-radius: 10px; border: none;
    font-family: 'Syne', sans-serif; font-size: 0.95rem; font-weight: 700;
    cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
  }
  .btn-primary {
    background: var(--accent); color: white;
  }
  .btn-primary:hover { background: #6d28d9; transform: translateY(-1px); }
  .btn-success { background: var(--success); color: white; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); }

  .btn-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }

  .output-box {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px; margin-top: 10px;
    font-family: 'Space Mono', monospace; font-size: 0.82rem;
    color: var(--success); min-height: 50px;
    display: none;
  }
  .output-box.visible { display: block; animation: fadeIn 0.3s; }
  .output-box.error { color: #f87171; }

  /* SCRATCH EDITOR */
  .editor-container {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; overflow: hidden;
  }
  .editor-toolbar {
    background: var(--surface2); padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
  }
  .editor-dots { display: flex; gap: 6px; }
  .dot { width: 12px; height: 12px; border-radius: 50%; }
  .dot-r { background: #f87171; }
  .dot-y { background: #fbbf24; }
  .dot-g { background: #34d399; }

  .lang-select {
    background: var(--surface); border: 1px solid var(--border);
    color: var(--text); padding: 6px 12px; border-radius: 8px;
    font-family: 'Space Mono', monospace; font-size: 0.8rem; cursor: pointer;
  }

  .editor-main { display: grid; grid-template-columns: 1fr 1fr; gap: 0; }
  @media (max-width: 768px) { .editor-main { grid-template-columns: 1fr; } }

  .editor-pane {
    position: relative;
    border-right: 1px solid var(--border);
  }
  .pane-label {
    padding: 8px 16px; font-size: 0.75rem; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase; color: var(--muted);
    border-bottom: 1px solid var(--border); background: var(--surface2);
  }

  #main-editor {
    width: 100%; height: 400px;
    background: var(--bg); border: none;
    padding: 20px; font-family: 'Space Mono', monospace;
    font-size: 0.85rem; line-height: 1.6; color: var(--text);
    resize: none; outline: none;
    tab-size: 2;
  }

  #output-display {
    height: 400px; padding: 20px;
    font-family: 'Space Mono', monospace; font-size: 0.82rem;
    color: var(--success); overflow-y: auto;
    background: var(--bg); white-space: pre-wrap; word-break: break-all;
  }

  .run-btn {
    margin: 12px 20px;
  }

  /* GIFT MODAL */
  .gift-modal-body { text-align: center; padding: 40px; }
  .gift-emoji { font-size: 5rem; display: block; margin-bottom: 16px; animation: bounce 0.8s ease infinite; }
  .gift-modal-body h2 { font-size: 1.8rem; font-weight: 800; margin-bottom: 8px; }
  .gift-xp {
    font-family: 'Space Mono', monospace;
    font-size: 2rem; font-weight: 700; color: var(--xp-color);
    margin: 16px 0;
  }
  .confetti { position: fixed; pointer-events: none; z-index: 300; }

  /* XP TOAST */
  .xp-toast {
    position: fixed; bottom: 30px; right: 30px; z-index: 500;
    background: var(--surface); border: 1px solid rgba(245,158,11,0.4);
    border-radius: 14px; padding: 14px 20px;
    font-family: 'Space Mono', monospace; font-weight: 700; color: var(--xp-color);
    font-size: 1rem;
    transform: translateX(120%);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex; align-items: center; gap: 10px;
  }
  .xp-toast.show { transform: translateX(0); }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; text-align: center;
  }
  .stat-value { font-family: 'Space Mono', monospace; font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
  .stat-label { font-size: 0.8rem; color: var(--muted); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }

  /* SOCIAL */
  .search-bar-wrap {
    position: relative; margin-bottom: 28px;
  }
  .search-bar-wrap input {
    width: 100%; padding: 14px 20px 14px 48px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 14px; color: var(--text);
    font-family: 'Syne', sans-serif; font-size: 1rem;
    outline: none; transition: border-color 0.2s;
  }
  .search-bar-wrap input:focus { border-color: var(--accent); }
  .search-bar-wrap input::placeholder { color: var(--muted); }
  .search-icon {
    position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
    color: var(--muted); font-size: 1.1rem; pointer-events: none;
  }
  .search-results {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 14px; margin-bottom: 32px;
  }

  .user-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 20px;
    display: flex; align-items: center; gap: 16px;
    transition: all 0.2s; cursor: pointer;
    position: relative;
  }
  .user-card:hover { border-color: var(--accent); transform: translateY(-2px); }

  .avatar {
    width: 52px; height: 52px; border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.6rem; flex-shrink: 0;
    border: 2px solid var(--border);
  }
  .user-info { flex: 1; min-width: 0; }
  .user-name { font-weight: 700; font-size: 1rem; margin-bottom: 2px; }
  .user-meta { font-size: 0.78rem; color: var(--muted); font-family: 'Space Mono', monospace; }
  .user-xp-badge {
    font-family: 'Space Mono', monospace; font-size: 0.75rem;
    color: var(--xp-color); background: rgba(245,158,11,0.1);
    border: 1px solid rgba(245,158,11,0.25);
    padding: 3px 9px; border-radius: 8px; margin-top: 4px; display: inline-block;
  }

  .friend-btn {
    padding: 8px 16px; border-radius: 10px; border: 1px solid var(--border);
    font-family: 'Syne', sans-serif; font-size: 0.8rem; font-weight: 700;
    cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;
  }
  .friend-btn.add { background: var(--accent); color: white; border-color: var(--accent); }
  .friend-btn.add:hover { background: #6d28d9; }
  .friend-btn.pending { background: rgba(245,158,11,0.1); color: var(--xp-color); border-color: rgba(245,158,11,0.3); cursor: default; }
  .friend-btn.friends { background: rgba(16,185,129,0.1); color: var(--success); border-color: rgba(16,185,129,0.3); }
  .friend-btn.friends:hover { background: rgba(239,68,68,0.1); color: #f87171; border-color: rgba(239,68,68,0.3); }

  /* Tabs within social */
  .social-tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--surface); padding: 4px; border-radius: 12px; width: fit-content; border: 1px solid var(--border); }
  .social-tab { padding: 8px 20px; border-radius: 9px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-family: 'Syne', sans-serif; font-size: 0.9rem; font-weight: 700; transition: all 0.2s; }
  .social-tab.active { background: var(--accent); color: white; }
  .social-tab-content { display: none; }
  .social-tab-content.active { display: block; }

  /* Friend request notification */
  .notif-dot {
    width: 8px; height: 8px; background: #f87171; border-radius: 50%;
    display: inline-block; margin-left: 6px; vertical-align: middle;
    animation: pulse 1.5s ease infinite;
  }
  @keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.3); } }

  /* USER PROFILE MODAL */
  .profile-modal .modal { max-width: 480px; }
  .profile-header {
    padding: 36px 28px 24px; text-align: center;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, rgba(124,58,237,0.06) 0%, transparent 100%);
  }
  .profile-avatar-lg {
    width: 80px; height: 80px; border-radius: 20px;
    display: flex; align-items: center; justify-content: center;
    font-size: 2.5rem; margin: 0 auto 16px;
    border: 2px solid var(--border);
  }
  .profile-username { font-size: 1.4rem; font-weight: 800; margin-bottom: 4px; }
  .profile-handle { font-family: 'Space Mono', monospace; font-size: 0.85rem; color: var(--muted); margin-bottom: 16px; }
  .profile-stats-row {
    display: flex; gap: 24px; justify-content: center;
    flex-wrap: wrap;
  }
  .profile-stat { text-align: center; }
  .profile-stat-val { font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; }
  .profile-stat-label { font-size: 0.72rem; color: var(--muted); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }

  .profile-body { padding: 24px 28px; }
  .profile-lessons-title { font-size: 0.85rem; font-weight: 700; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 12px; }
  .profile-lesson-badge {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600;
    margin: 3px; border: 1px solid var(--border); background: var(--surface2);
    color: var(--muted);
  }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-state .empty-icon { font-size: 3rem; display: block; margin-bottom: 12px; opacity: 0.5; }

  .friend-requests-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
  .request-card {
    background: var(--surface); border: 1px solid rgba(245,158,11,0.2);
    border-radius: 14px; padding: 16px;
    display: flex; align-items: center; gap: 12px;
  }
  .request-actions { display: flex; gap: 8px; margin-left: auto; }
  .req-accept { padding: 7px 14px; background: var(--success); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.8rem; transition: opacity 0.2s; }
  .req-accept:hover { opacity: 0.85; }
  .req-decline { padding: 7px 14px; background: var(--surface2); color: var(--muted); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.8rem; transition: all 0.2s; }
  .req-decline:hover { color: #f87171; border-color: rgba(239,68,68,0.3); }

  .leaderboard-row {
    display: flex; align-items: center; gap: 14px;
    padding: 14px 18px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; margin-bottom: 8px; cursor: pointer;
    transition: all 0.2s;
  }
  .leaderboard-row:hover { border-color: var(--accent); transform: translateX(4px); }
  .rank-num { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 0.9rem; color: var(--muted); width: 28px; text-align: center; }
  .rank-num.gold { color: #f59e0b; }
  .rank-num.silver { color: #94a3b8; }
  .rank-num.bronze { color: #cd7c4b; }
  /* AUTH SCREEN */
  #auth-screen {
    position: fixed; inset: 0; z-index: 999;
    background: var(--bg); display: flex; align-items: center; justify-content: center;
    flex-direction: column;
  }
  #auth-screen::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(124,58,237,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(124,58,237,0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }
  .auth-glow {
    position: absolute; width: 600px; height: 600px; border-radius: 50%;
    background: radial-gradient(circle, rgba(124,58,237,0.12) 0%, transparent 70%);
    pointer-events: none;
  }
  .auth-box {
    position: relative; z-index: 1;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 28px; padding: 48px 44px; width: 90%; max-width: 420px;
    text-align: center;
    animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  .auth-logo {
    font-family: 'Space Mono', monospace; font-size: 2rem; font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 6px;
  }
  .auth-logo span { -webkit-text-fill-color: var(--accent3); }
  .auth-tagline { color: var(--muted); font-size: 0.9rem; margin-bottom: 36px; }

  .auth-panel { display: none; }
  .auth-panel.active { display: block; animation: fadeIn 0.25s ease; }

  .auth-input-group { margin-bottom: 14px; text-align: left; }
  .auth-input-group label { display: block; font-size: 0.78rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
  .auth-input {
    width: 100%; padding: 12px 16px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text);
    font-family: 'Syne', sans-serif; font-size: 0.95rem;
    outline: none; transition: border-color 0.2s;
  }
  .auth-input:focus { border-color: var(--accent); }
  .auth-input::placeholder { color: var(--muted); }

  .auth-btn-row { display: flex; gap: 10px; margin-top: 8px; }
  .auth-submit {
    width: 100%; padding: 14px; border-radius: 12px; border: none;
    background: linear-gradient(135deg, var(--accent), #6d28d9);
    color: white; font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    cursor: pointer; transition: all 0.2s; margin-top: 8px;
  }
  .auth-submit:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(124,58,237,0.35); }
  .auth-submit:active { transform: translateY(0); }

  .auth-divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; }
  .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .auth-divider span { color: var(--muted); font-size: 0.8rem; }

  .auth-switch { color: var(--muted); font-size: 0.85rem; margin-top: 20px; }
  .auth-switch a { color: var(--accent2); cursor: pointer; font-weight: 700; text-decoration: none; }
  .auth-switch a:hover { text-decoration: underline; }

  .auth-error {
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
    color: #f87171; border-radius: 8px; padding: 10px 14px;
    font-size: 0.85rem; margin-bottom: 14px; display: none;
    text-align: left;
  }
  .auth-error.show { display: block; animation: fadeIn 0.2s; }

  .auth-features {
    display: flex; justify-content: center; gap: 20px; margin-bottom: 32px; flex-wrap: wrap;
  }
  .auth-feature { font-size: 0.82rem; color: var(--muted); display: flex; align-items: center; gap: 5px; }

  /* PROFILE HERO */
  .profile-hero-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 28px 32px;
    display: flex; align-items: center; justify-content: space-between;
    background: linear-gradient(135deg, rgba(124,58,237,0.07) 0%, rgba(6,182,212,0.04) 100%);
  }
  .profile-hero-left { display: flex; align-items: center; gap: 20px; }
  .profile-hero-name { font-size: 1.6rem; font-weight: 800; }
  .profile-hero-level { color: var(--muted); font-size: 0.9rem; margin-top: 3px; font-family: 'Space Mono', monospace; }

  .avatar-picker-wrap { position: relative; }
  .avatar-display {
    width: 80px; height: 80px; border-radius: 20px;
    background: var(--surface2); border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 2.4rem; cursor: pointer; position: relative; overflow: hidden;
    transition: all 0.2s;
  }
  .avatar-display:hover { border-color: var(--accent); transform: scale(1.04); }
  .avatar-edit-overlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.65); display: flex; align-items: center; justify-content: center;
    font-size: 0.75rem; font-weight: 700; color: white; letter-spacing: 0.5px;
    opacity: 0; transition: opacity 0.2s;
  }
  .avatar-display:hover .avatar-edit-overlay { opacity: 1; }

  /* AVATAR GRID */
  .avatar-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(52px, 1fr)); gap: 8px;
  }
  .avatar-option {
    width: 52px; height: 52px; border-radius: 12px;
    background: var(--surface2); border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.6rem; cursor: pointer;
    transition: all 0.15s;
  }
  .avatar-option:hover { border-color: var(--accent); transform: scale(1.1); background: rgba(124,58,237,0.1); }
  .avatar-option.selected { border-color: var(--accent2); background: rgba(6,182,212,0.15); box-shadow: 0 0 0 3px rgba(6,182,212,0.2); }

  .avatar-cat-label { font-size:0.75rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:10px; }

  /* UPLOAD ZONE */
  .upload-zone {
    border: 2px dashed var(--border); border-radius: 16px;
    padding: 28px 20px; text-align: center; cursor: pointer;
    transition: all 0.2s; background: var(--surface2); margin-bottom: 6px;
    position: relative; overflow: hidden;
  }
  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent); background: rgba(124,58,237,0.05);
  }
  .upload-zone.drag-over { border-style: solid; }
  .upload-icon { font-size: 2.2rem; margin-bottom: 8px; display: block; }
  .upload-label { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; }
  .upload-hint { font-size: 0.78rem; color: var(--muted); }

  .upload-preview { pointer-events: none; }
  .upload-preview img {
    width: 90px; height: 90px; border-radius: 50%; object-fit: cover;
    border: 3px solid var(--accent); margin-bottom: 10px;
    display: block; margin-left: auto; margin-right: auto;
  }
  .upload-preview .uploaded-label { font-weight: 700; color: var(--success); font-size: 0.9rem; }
  .upload-preview .change-hint { font-size: 0.78rem; color: var(--muted); margin-top: 2px; }

  .remove-photo-btn {
    display: none; margin: 8px auto 0; padding: 6px 16px;
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
    color: #f87171; border-radius: 8px; cursor: pointer;
    font-family: 'Syne', sans-serif; font-size: 0.8rem; font-weight: 700;
    transition: all 0.2s;
  }
  .remove-photo-btn:hover { background: rgba(239,68,68,0.2); }
  .remove-photo-btn.visible { display: block; }

  .avatar-section-divider {
    display: flex; align-items: center; gap: 12px;
    margin: 20px 0 18px; color: var(--muted); font-size: 0.8rem;
  }
  .avatar-section-divider::before, .avatar-section-divider::after {
    content: ''; flex: 1; height: 1px; background: var(--border);
  }

</style>
</head>
<body>
<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-glow"></div>
  <div class="auth-box">
    <div class="auth-logo">code<span>craft</span></div>
    <div class="auth-tagline">Learn to code. Actually fun.</div>

    <div class="auth-features">
      <div class="auth-feature">‚ö° Earn XP</div>
      <div class="auth-feature">üéÅ Daily Gifts</div>
      <div class="auth-feature">üë• Add Friends</div>
      <div class="auth-feature">üìö 8 Lessons</div>
    </div>

    <!-- LANDING: two buttons -->
    <div class="auth-panel active" id="panel-landing">
      <button class="auth-submit" onclick="showPanel('signup')" style="margin-bottom:10px">
        ‚ú® Sign Up ‚Äî It's Free
      </button>
      <button class="auth-submit" onclick="showPanel('login')" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);box-shadow:none">
        üîë Log In
      </button>
    </div>

    <!-- SIGN UP -->
    <div class="auth-panel" id="panel-signup">
      <div class="auth-error" id="signup-error"></div>
      <div class="auth-input-group">
        <label>Username</label>
        <input class="auth-input" id="signup-username" type="text" placeholder="coolcoder123" maxlength="20">
      </div>
      <div class="auth-input-group">
        <label>Email</label>
        <input class="auth-input" id="signup-email" type="email" placeholder="you@example.com">
      </div>
      <div class="auth-input-group">
        <label>Password</label>
        <input class="auth-input" id="signup-password" type="password" placeholder="Min. 6 characters">
      </div>
      <button class="auth-submit" onclick="handleSignup()">Create Account ‚Üí</button>
      <div class="auth-switch">Already have an account? <a onclick="showPanel('login')">Log in</a></div>
      <div class="auth-switch" style="margin-top:8px"><a onclick="showPanel('landing')" style="color:var(--muted)">‚Üê Back</a></div>
    </div>

    <!-- LOG IN -->
    <div class="auth-panel" id="panel-login">
      <div class="auth-error" id="login-error"></div>
      <div class="auth-input-group">
        <label>Email</label>
        <input class="auth-input" id="login-email" type="email" placeholder="you@example.com">
      </div>
      <div class="auth-input-group">
        <label>Password</label>
        <input class="auth-input" id="login-password" type="password" placeholder="Your password">
      </div>
      <button class="auth-submit" onclick="handleLogin()">Log In ‚Üí</button>
      <div class="auth-switch">Don't have an account? <a onclick="showPanel('signup')">Sign up</a></div>
      <div class="auth-switch" style="margin-top:8px"><a onclick="showPanel('landing')" style="color:var(--muted)">‚Üê Back</a></div>
    </div>
  </div>
</div>

<div class="app" id="main-app" style="display:none">
  <nav>
    <div class="logo">code<span>craft</span></div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showSection('home')">üè† Home</button>
      <button class="nav-tab" onclick="showSection('lessons')">üìö Lessons</button>
      <button class="nav-tab" onclick="showSection('scratch')">‚å®Ô∏è Sandbox</button>
      <button class="nav-tab" onclick="showSection('social')">üë• Friends <span id="friend-notif" class="notif-dot" style="display:none"></span></button>
      <button class="nav-tab" onclick="showSection('profile')">üë§ Profile</button>
    </div>
    <div class="nav-stats">
      <div class="streak-badge">üî• <span id="streak-count">3</span> day streak</div>
      <div class="xp-badge">‚ö° <span id="nav-xp">0</span> XP</div>
      <div style="font-family:'Space Mono',monospace;font-size:0.8rem;color:var(--muted);padding:6px 10px;border:1px solid var(--border);border-radius:20px;display:flex;align-items:center;gap:6px"><span id="nav-avatar">üßë‚Äçüíª</span> <span id="nav-username"></span></div>
      <button onclick="handleLogout()" style="padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:0.8rem;font-weight:700;transition:all 0.2s" onmouseover="this.style.color='#f87171';this.style.borderColor='rgba(239,68,68,0.4)'" onmouseout="this.style.color='var(--muted)';this.style.borderColor='var(--border)'">Log Out</button>
    </div>
  </nav>

  <main>
    <!-- HOME -->
    <div class="section active" id="section-home">
      <div class="hero">
        <h1>Learn to code.<br><em>Actually fun.</em></h1>
        <p>Bite-sized lessons, real XP rewards, and daily surprises to keep you going.</p>
        <div class="daily-gift-banner" onclick="openGift()" id="gift-banner">
          <div class="gift-icon">üéÅ</div>
          <div class="gift-text">
            <strong>Daily Gift Available!</strong>
            <small>Claim your bonus XP today ‚Üí</small>
          </div>
        </div>

        <div class="progress-section">
          <div class="progress-header">
            <span class="level-label">üéÆ Level <span id="level-num">1</span> ‚Äî <span id="level-name">Beginner</span></span>
            <span class="xp-label"><span id="progress-xp">0</span> / <span id="progress-max">200</span> XP</span>
          </div>
          <div class="progress-bar-outer">
            <div class="progress-bar-inner" id="progress-bar" style="width:0%"></div>
          </div>
        </div>
      </div>

      <div class="section-title">Continue Learning <span>‚Üí</span></div>
      <div class="lessons-grid" id="home-lessons"></div>
    </div>

    <!-- LESSONS -->
    <div class="section" id="section-lessons">
      <div class="section-title">All Lessons <span>üìö</span></div>
      <div class="lessons-grid" id="all-lessons"></div>
    </div>

    <!-- SCRATCH -->
    <div class="section" id="section-scratch">
      <div class="section-title" style="margin-bottom:16px">Code Sandbox <span>‚å®Ô∏è</span></div>
      <p style="color:var(--muted);margin-bottom:24px">Write and run JavaScript or HTML/CSS right here. No setup needed.</p>
      <div class="editor-container">
        <div class="editor-toolbar">
          <div class="editor-dots">
            <div class="dot dot-r"></div>
            <div class="dot dot-y"></div>
            <div class="dot dot-g"></div>
          </div>
          <select class="lang-select" id="lang-select" onchange="switchLang()">
            <option value="js">JavaScript</option>
            <option value="html">HTML/CSS</option>
          </select>
          <div style="color:var(--muted);font-size:0.8rem;font-family:'Space Mono',monospace" id="lang-hint">// JavaScript mode</div>
          <button class="btn btn-primary run-btn" onclick="runCode()" style="margin:0">‚ñ∂ Run Code</button>
        </div>
        <div class="editor-main">
          <div class="editor-pane">
            <div class="pane-label">Editor</div>
            <textarea id="main-editor" spellcheck="false" placeholder="// Write your code here...
// Try: console.log('Hello, World!')"></textarea>
          </div>
          <div class="editor-pane" style="border-right:none">
            <div class="pane-label">Output</div>
            <div id="output-display">// Output will appear here...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SOCIAL / FRIENDS -->
    <div class="section" id="section-social">
      <div class="section-title">Community <span>üë•</span></div>

      <!-- Search bar -->
      <div class="search-bar-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="user-search" placeholder="Search users by name or @handle..." oninput="handleSearch(this.value)" autocomplete="off">
      </div>

      <!-- Search results (shown when searching) -->
      <div id="search-results-wrap" style="display:none">
        <div class="section-title" style="font-size:1.1rem;margin-bottom:16px">Search Results</div>
        <div class="search-results" id="search-results-grid"></div>
        <hr style="border-color:var(--border);margin:28px 0">
      </div>

      <!-- Tabs: Friends | Requests | Leaderboard -->
      <div class="social-tabs">
        <button class="social-tab active" onclick="switchSocialTab('friends', this)">My Friends</button>
        <button class="social-tab" onclick="switchSocialTab('requests', this)" id="req-tab">Requests <span id="req-count-badge" style="display:none;background:rgba(239,68,68,0.2);color:#f87171;font-size:0.7rem;padding:1px 6px;border-radius:6px;margin-left:4px"></span></button>

      </div>

      <!-- Friends list -->
      <div class="social-tab-content active" id="tab-friends">
        <div id="friends-list-container"></div>
      </div>

      <!-- Requests -->
      <div class="social-tab-content" id="tab-requests">
        <div id="requests-container"></div>
      </div>


    </div>

    <!-- PROFILE -->
    <div class="section" id="section-profile">

      <!-- Profile Header Card -->
      <div class="profile-hero-card">
        <div class="profile-hero-left">
          <div class="avatar-picker-wrap">
            <div class="avatar-display" id="profile-avatar-display" onclick="openAvatarPicker()">
              <span id="profile-avatar-emoji">üßë‚Äçüíª</span>
              <div class="avatar-edit-overlay">‚úèÔ∏è Edit</div>
            </div>
          </div>
          <div>
            <div style="display:flex;align-items:center;gap:10px" id="username-display-row">
              <div class="profile-hero-name" id="profile-hero-username">‚Äî</div>
              <button onclick="startEditUsername()" style="background:rgba(124,58,237,0.12);border:1px solid rgba(124,58,237,0.3);color:#a78bfa;border-radius:8px;padding:4px 10px;cursor:pointer;font-size:0.75rem;font-weight:700;font-family:'Syne',sans-serif;transition:all 0.2s" onmouseover="this.style.background='rgba(124,58,237,0.25)'" onmouseout="this.style.background='rgba(124,58,237,0.12)'">‚úèÔ∏è Edit</button>
            </div>
            <div style="display:none;align-items:center;gap:8px" id="username-edit-row">
              <input id="username-edit-input" type="text" maxlength="20" style="background:var(--surface2);border:1px solid var(--accent);border-radius:8px;padding:6px 12px;color:var(--text);font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;outline:none;width:180px">
              <button onclick="saveUsername()" style="background:var(--accent);border:none;color:white;border-radius:8px;padding:6px 12px;cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;font-size:0.8rem">Save</button>
              <button onclick="cancelEditUsername()" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:8px;padding:6px 10px;cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;font-size:0.8rem">‚úï</button>
            </div>
            <div class="profile-hero-level" id="profile-hero-level">Level 1 ¬∑ Beginner</div>
          </div>
        </div>
      </div>

      <div class="section-title" style="margin-top:32px">Stats <span>üìä</span></div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-xp" style="color:var(--xp-color)">0</div>
          <div class="stat-label">Total XP</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-level" style="color:var(--accent)">1</div>
          <div class="stat-label">Current Level</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-completed" style="color:var(--success)">0</div>
          <div class="stat-label">Lessons Done</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-streak" style="color:#f87171">3</div>
          <div class="stat-label">Day Streak üî•</div>
        </div>
      </div>
      <div class="section-title" style="font-size:1.2rem">Completed Lessons</div>
      <div id="completed-list" style="color:var(--muted);font-size:0.9rem">No lessons completed yet. Start learning!</div>

      <div style="margin-top:48px;padding-top:28px;border-top:1px solid var(--border);display:flex;justify-content:center">
        <button onclick="handleLogout()" style="
          display:flex;align-items:center;gap:10px;
          padding:14px 32px;border-radius:12px;
          background:rgba(239,68,68,0.08);
          border:1px solid rgba(239,68,68,0.25);
          color:#f87171;font-family:'Syne',sans-serif;
          font-size:1rem;font-weight:700;cursor:pointer;
          transition:all 0.2s;
        "
        onmouseover="this.style.background='rgba(239,68,68,0.16)';this.style.borderColor='rgba(239,68,68,0.5)';this.style.transform='translateY(-1px)'"
        onmouseout="this.style.background='rgba(239,68,68,0.08)';this.style.borderColor='rgba(239,68,68,0.25)';this.style.transform='translateY(0)'">
          üö™ Log Out
        </button>
      </div>
    </div>
  </main>
</div>

<!-- AVATAR PICKER MODAL -->
<div class="modal-overlay" id="avatar-modal">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      <div>
        <h2 style="font-size:1.3rem;font-weight:800">Choose Your Avatar</h2>
        <p style="color:var(--muted);font-size:0.85rem;margin-top:4px">Upload a photo or pick an emoji</p>
      </div>
      <button class="close-btn" onclick="closeAvatarPicker()">‚úï</button>
    </div>
    <div class="modal-body">

      <!-- Upload section -->
      <div class="upload-zone" id="upload-zone" onclick="document.getElementById('avatar-file-input').click()" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="handleAvatarDrop(event)">
        <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarFile(this.files[0])">
        <div class="upload-preview" id="upload-preview">
          <div class="upload-icon">üì∑</div>
          <div class="upload-label">Click to upload a photo</div>
          <div class="upload-hint">JPG, PNG, GIF, WebP ¬∑ Max 5MB ¬∑ Drag & drop supported</div>
        </div>
      </div>

      <div class="avatar-section-divider"><span>or choose an emoji</span></div>

      <div style="margin-bottom:16px">
        <div class="avatar-cat-label">People</div>
        <div class="avatar-grid" id="avatar-grid-people"></div>
      </div>
      <div style="margin-bottom:16px">
        <div class="avatar-cat-label">Tech & Code</div>
        <div class="avatar-grid" id="avatar-grid-tech"></div>
      </div>
      <div style="margin-bottom:16px">
        <div class="avatar-cat-label">Animals</div>
        <div class="avatar-grid" id="avatar-grid-animals"></div>
      </div>
      <div style="margin-bottom:16px">
        <div class="avatar-cat-label">Fun & Misc</div>
        <div class="avatar-grid" id="avatar-grid-misc"></div>
      </div>
    </div>
  </div>
</div>

<!-- USER PROFILE MODAL -->
<div class="modal-overlay profile-modal" id="user-profile-modal">
  <div class="modal" style="max-width:480px">
    <div class="profile-header">
      <button class="close-btn" onclick="closeUserModal()" style="position:absolute;top:16px;right:16px">‚úï</button>
      <div class="profile-avatar-lg" id="upm-avatar"></div>
      <div class="profile-username" id="upm-name"></div>
      <div class="profile-handle" id="upm-handle"></div>
      <div class="profile-stats-row">
        <div class="profile-stat">
          <div class="profile-stat-val" id="upm-xp" style="color:var(--xp-color)"></div>
          <div class="profile-stat-label">XP</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-val" id="upm-level" style="color:var(--accent)"></div>
          <div class="profile-stat-label">Level</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-val" id="upm-lessons" style="color:var(--success)"></div>
          <div class="profile-stat-label">Lessons</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-val" id="upm-streak" style="color:#f87171"></div>
          <div class="profile-stat-label">Streak üî•</div>
        </div>
      </div>
    </div>
    <div class="profile-body">
      <div id="upm-friend-action" style="margin-bottom:20px;display:flex;justify-content:center"></div>
      <div class="profile-lessons-title">Completed Lessons</div>
      <div id="upm-lessons-list"></div>
    </div>
  </div>
</div>

<!-- LESSON MODAL -->
<div class="modal-overlay" id="lesson-modal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div id="modal-tag" class="lesson-tag">JS</div>
        <h2 id="modal-title" style="font-size:1.4rem;font-weight:800"></h2>
        <div id="modal-xp-display" style="font-family:'Space Mono',monospace;color:var(--xp-color);font-size:0.85rem;margin-top:4px"></div>
      </div>
      <button class="close-btn" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- GIFT MODAL -->
<div class="modal-overlay" id="gift-modal">
  <div class="modal" style="max-width:420px">
    <div class="gift-modal-body" id="gift-body">
      <span class="gift-emoji">üéÅ</span>
      <h2>Daily Reward!</h2>
      <p style="color:var(--muted);margin-bottom:8px">You've earned your daily bonus XP!</p>
      <div class="gift-xp" id="gift-xp-amount">+50 XP</div>
      <button class="btn btn-success" onclick="claimGift()" style="width:100%;justify-content:center;margin-top:16px;font-size:1rem">
        üéâ Claim Reward
      </button>
    </div>
  </div>
</div>

<!-- XP TOAST -->
<div class="xp-toast" id="xp-toast">‚ö° <span id="toast-amount"></span> XP!</div>

<script>
// ---- FAVICON ----
(function() {
  const c = document.createElement('canvas');
  c.width = 64; c.height = 64;
  const ctx = c.getContext('2d');
  // Purple rounded square
  const r = 14;
  ctx.beginPath();
  ctx.moveTo(r, 0);
  ctx.lineTo(64-r, 0);
  ctx.quadraticCurveTo(64, 0, 64, r);
  ctx.lineTo(64, 64-r);
  ctx.quadraticCurveTo(64, 64, 64-r, 64);
  ctx.lineTo(r, 64);
  ctx.quadraticCurveTo(0, 64, 0, 64-r);
  ctx.lineTo(0, r);
  ctx.quadraticCurveTo(0, 0, r, 0);
  ctx.closePath();
  ctx.fillStyle = '#7c3aed';
  ctx.fill();
  // </> text
  ctx.fillStyle = 'white';
  ctx.font = 'bold 26px monospace';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('</>', 32, 34);
  // Set favicon
  const link = document.getElementById('favicon');
  if (link) link.href = c.toDataURL('image/png');
})();

// ---- AUTH ----
function showPanel(name) {
  document.querySelectorAll('.auth-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  // clear errors
  ['signup-error','login-error'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.classList.remove('show'); el.textContent = ''; }
  });
}

function showAuthError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg; el.classList.add('show');
}

function handleSignup() {
  const username = document.getElementById('signup-username').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  if (!username) return showAuthError('signup-error', 'Please enter a username.');
  if (username.length < 3) return showAuthError('signup-error', 'Username must be at least 3 characters.');
  if (!email || !email.includes('@')) return showAuthError('signup-error', 'Please enter a valid email.');
  if (password.length < 6) return showAuthError('signup-error', 'Password must be at least 6 characters.');
  // Save account
  try {
    const accounts = JSON.parse(localStorage.getItem('codecraft-accounts') || '{}');
    if (accounts[email]) return showAuthError('signup-error', 'An account with this email already exists.');
    accounts[email] = { username, email, password };
    localStorage.setItem('codecraft-accounts', JSON.stringify(accounts));
    localStorage.setItem('codecraft-session', JSON.stringify({ email, username }));
  } catch(e) {}
  enterApp(username);
}

function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email) return showAuthError('login-error', 'Please enter your email.');
  if (!password) return showAuthError('login-error', 'Please enter your password.');
  try {
    const accounts = JSON.parse(localStorage.getItem('codecraft-accounts') || '{}');
    const acct = accounts[email];
    if (!acct) return showAuthError('login-error', 'No account found with that email.');
    if (acct.password !== password) return showAuthError('login-error', 'Incorrect password.');
    localStorage.setItem('codecraft-session', JSON.stringify({ email, username: acct.username }));
    enterApp(acct.username);
  } catch(e) { showAuthError('login-error', 'Something went wrong. Please try again.'); }
}

function enterApp(username) {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'flex';
  // Show username in nav
  document.getElementById('nav-username').textContent = username;
  updateUI();
  if (socialState.requests.length > 0) {
    document.getElementById('friend-notif').style.display = 'inline-block';
  }
}

function handleLogout() {
  try { localStorage.removeItem('codecraft-session'); } catch(e) {}
  document.getElementById('main-app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
  showPanel('login');
  // Clear login fields
  const emailEl = document.getElementById('login-email');
  const passEl = document.getElementById('login-password');
  if (emailEl) emailEl.value = '';
  if (passEl) passEl.value = '';
}

// Check for existing session on load
document.addEventListener('DOMContentLoaded', () => {
  try {
    const session = JSON.parse(localStorage.getItem('codecraft-session') || 'null');
    if (session && session.username) {
      enterApp(session.username);
    }
  } catch(e) {}
});

// ---- STATE ----
let state = {
  xp: 0,
  level: 1,
  streak: 3,
  completed: [],
  giftClaimed: false,
  giftXP: [50, 75, 100, 25, 150][Math.floor(Math.random()*5)]
};

// Try load from localStorage
try {
  const saved = localStorage.getItem('codecraft');
  if (saved) {
    const parsed = JSON.parse(saved);
    // Only load if today matches
    const today = new Date().toDateString();
    state = { ...state, ...parsed };
    if (parsed.lastLogin !== today) {
      state.giftClaimed = false;
      state.giftXP = [50, 75, 100, 25, 150][Math.floor(Math.random()*5)];
    }
  }
} catch(e) {}

function saveState() {
  try {
    localStorage.setItem('codecraft', JSON.stringify({
      ...state, lastLogin: new Date().toDateString()
    }));
  } catch(e) {}
}

// ---- LESSONS DATA ----
const lessons = [
  {
    id: 1, tag: 'html', tagClass: 'tag-html', title: 'Your First HTML Page',
    desc: 'Learn the basic structure of an HTML document.',
    xp: 30, difficulty: 'Beginner',
    content: `
      <p>HTML (HyperText Markup Language) is the backbone of every webpage. It defines the structure and content of a page using <strong>tags</strong>.</p>
      <h3>Basic Structure</h3>
      <div class="code-block"><span class="cm">&lt;!-- Every HTML page looks like this --&gt;</span>
<span class="kw">&lt;!DOCTYPE html&gt;</span>
<span class="kw">&lt;html&gt;</span>
  <span class="kw">&lt;head&gt;</span>
    <span class="kw">&lt;title&gt;</span>My Page<span class="kw">&lt;/title&gt;</span>
  <span class="kw">&lt;/head&gt;</span>
  <span class="kw">&lt;body&gt;</span>
    <span class="kw">&lt;h1&gt;</span>Hello World!<span class="kw">&lt;/h1&gt;</span>
    <span class="kw">&lt;p&gt;</span>This is a paragraph.<span class="kw">&lt;/p&gt;</span>
  <span class="kw">&lt;/body&gt;</span>
<span class="kw">&lt;/html&gt;</span></div>
      <h3>Key Tags</h3>
      <p><code style="background:var(--surface2);padding:2px 6px;border-radius:4px">&lt;h1&gt;</code> to <code style="background:var(--surface2);padding:2px 6px;border-radius:4px">&lt;h6&gt;</code> are headings (h1 is biggest). <code style="background:var(--surface2);padding:2px 6px;border-radius:4px">&lt;p&gt;</code> is for paragraphs. Tags come in pairs ‚Äî an opening tag and closing tag.</p>
    `,
    challenge: 'Write an HTML snippet with an h1 heading that says "Hello CodeCraft!" and a paragraph below it.',
    answer: 'h1'
  },
  {
    id: 2, tag: 'css', tagClass: 'tag-css', title: 'Styling with CSS',
    desc: 'Make your HTML beautiful with colors, fonts, and spacing.',
    xp: 40, difficulty: 'Beginner',
    content: `
      <p>CSS (Cascading Style Sheets) controls how your HTML looks. You can change colors, fonts, sizes, spacing, and much more.</p>
      <h3>CSS Syntax</h3>
      <div class="code-block"><span class="fn">h1</span> {
  <span class="kw">color</span>: <span class="str">blue</span>;
  <span class="kw">font-size</span>: <span class="num">32px</span>;
}

<span class="fn">p</span> {
  <span class="kw">color</span>: <span class="str">#666</span>;
  <span class="kw">background</span>: <span class="str">lightyellow</span>;
  <span class="kw">padding</span>: <span class="num">10px</span>;
}</div>
      <p>A CSS rule has a <strong>selector</strong> (what to style) and <strong>declarations</strong> (how to style it). Each declaration is a property and value pair.</p>
    `,
    challenge: 'Write CSS to make h1 red and add 20px padding to paragraphs.',
    answer: 'color'
  },
  {
    id: 3, tag: 'js', tagClass: 'tag-js', title: 'JavaScript Variables',
    desc: 'Store data and make your pages interactive with variables.',
    xp: 50, difficulty: 'Beginner',
    content: `
      <p>JavaScript is the programming language of the web. It makes pages interactive! <strong>Variables</strong> store data you can use and change.</p>
      <h3>Declaring Variables</h3>
      <div class="code-block"><span class="kw">let</span> name = <span class="str">"Alice"</span>;    <span class="cm">// can change</span>
<span class="kw">const</span> age = <span class="num">25</span>;       <span class="cm">// can't change</span>
<span class="kw">var</span> score = <span class="num">100</span>;     <span class="cm">// old style</span>

<span class="fn">console.log</span>(name);    <span class="cm">// prints: Alice</span>
<span class="fn">console.log</span>(<span class="str">"Age: "</span> + age); <span class="cm">// Age: 25</span></div>
      <p>Use <code style="background:var(--surface2);padding:2px 6px;border-radius:4px">let</code> for variables that change, and <code style="background:var(--surface2);padding:2px 6px;border-radius:4px">const</code> for ones that stay the same.</p>
    `,
    challenge: 'Declare a variable called "score" with value 42, then console.log it.',
    answer: 'score'
  },
  {
    id: 4, tag: 'js', tagClass: 'tag-js', title: 'Functions',
    desc: 'Reusable blocks of code that do specific tasks.',
    xp: 60, difficulty: 'Beginner',
    content: `
      <p>Functions let you group code into reusable blocks. Write once, run many times!</p>
      <h3>Defining and Calling Functions</h3>
      <div class="code-block"><span class="kw">function</span> <span class="fn">greet</span>(name) {
  <span class="kw">return</span> <span class="str">"Hello, "</span> + name + <span class="str">"!"</span>;
}

<span class="fn">console.log</span>(<span class="fn">greet</span>(<span class="str">"World"</span>));  <span class="cm">// Hello, World!</span>
<span class="fn">console.log</span>(<span class="fn">greet</span>(<span class="str">"Alice"</span>)); <span class="cm">// Hello, Alice!</span>

<span class="cm">// Arrow function (modern style)</span>
<span class="kw">const</span> add = (a, b) => a + b;
<span class="fn">console.log</span>(<span class="fn">add</span>(<span class="num">3</span>, <span class="num">4</span>)); <span class="cm">// 7</span></div>
    `,
    challenge: 'Write a function called "double" that takes a number and returns it multiplied by 2. Call it with 7.',
    answer: 'function'
  },
  {
    id: 5, tag: 'js', tagClass: 'tag-js', title: 'Arrays & Loops',
    desc: 'Store lists of data and iterate through them.',
    xp: 70, difficulty: 'Intermediate',
    content: `
      <p>Arrays store multiple values in one variable. Loops let you repeat code.</p>
      <h3>Arrays</h3>
      <div class="code-block"><span class="kw">const</span> fruits = [<span class="str">"apple"</span>, <span class="str">"banana"</span>, <span class="str">"cherry"</span>];
<span class="fn">console.log</span>(fruits[<span class="num">0</span>]); <span class="cm">// apple</span>
<span class="fn">console.log</span>(fruits.length); <span class="cm">// 3</span>

<span class="cm">// forEach loop</span>
fruits.<span class="fn">forEach</span>(fruit => {
  <span class="fn">console.log</span>(<span class="str">"I like "</span> + fruit);
});

<span class="cm">// for loop</span>
<span class="kw">for</span> (<span class="kw">let</span> i = <span class="num">0</span>; i < fruits.length; i++) {
  <span class="fn">console.log</span>(fruits[i]);
}</div>
    `,
    challenge: 'Create an array of 3 colors, then use forEach to console.log each one.',
    answer: 'forEach'
  },
  {
    id: 6, tag: 'py', tagClass: 'tag-py', title: 'Python Basics',
    desc: 'Introduction to Python ‚Äî clean, readable, powerful.',
    xp: 55, difficulty: 'Beginner',
    content: `
      <p>Python is one of the most beginner-friendly languages. It's used in web dev, data science, AI, and automation.</p>
      <h3>Your First Python Code</h3>
      <div class="code-block"><span class="cm"># Print to the console</span>
<span class="fn">print</span>(<span class="str">"Hello, Python!"</span>)

<span class="cm"># Variables</span>
name = <span class="str">"Alice"</span>
age = <span class="num">25</span>
is_happy = <span class="kw">True</span>

<span class="cm"># f-strings (like template literals)</span>
<span class="fn">print</span>(<span class="kw">f</span><span class="str">"My name is {name}, I'm {age}"</span>)

<span class="cm"># List (like arrays)</span>
colors = [<span class="str">"red"</span>, <span class="str">"green"</span>, <span class="str">"blue"</span>]
<span class="kw">for</span> color <span class="kw">in</span> colors:
    <span class="fn">print</span>(color)</div>
    `,
    challenge: 'Write Python code that creates a list of 3 animals and prints each one.',
    answer: 'print'
  },
  {
    id: 7, tag: 'css', tagClass: 'tag-css', title: 'CSS Flexbox',
    desc: 'Build powerful layouts with CSS flexbox.',
    xp: 65, difficulty: 'Intermediate',
    content: `
      <p>Flexbox is a layout model that makes it easy to arrange items in rows or columns and align them perfectly.</p>
      <h3>Basic Flexbox</h3>
      <div class="code-block"><span class="fn">.container</span> {
  <span class="kw">display</span>: <span class="str">flex</span>;
  <span class="kw">justify-content</span>: <span class="str">center</span>;   <span class="cm">/* horizontal */</span>
  <span class="kw">align-items</span>: <span class="str">center</span>;       <span class="cm">/* vertical */</span>
  <span class="kw">gap</span>: <span class="num">16px</span>;
  <span class="kw">flex-wrap</span>: <span class="str">wrap</span>;
}

<span class="fn">.item</span> {
  <span class="kw">flex</span>: <span class="num">1</span>;  <span class="cm">/* grow equally */</span>
  <span class="kw">min-width</span>: <span class="num">200px</span>;
}</div>
    `,
    challenge: 'Write CSS using flexbox to center items both horizontally and vertically.',
    answer: 'flex'
  },
  {
    id: 8, tag: 'js', tagClass: 'tag-js', title: 'DOM Manipulation',
    desc: 'Control your HTML page dynamically with JavaScript.',
    xp: 80, difficulty: 'Intermediate',
    content: `
      <p>The DOM (Document Object Model) is your HTML page as a JavaScript object. You can read, change, add, and remove elements dynamically.</p>
      <h3>Selecting & Changing Elements</h3>
      <div class="code-block"><span class="cm">// Select an element</span>
<span class="kw">const</span> title = document.<span class="fn">querySelector</span>(<span class="str">"h1"</span>);
<span class="kw">const</span> btn = document.<span class="fn">getElementById</span>(<span class="str">"myBtn"</span>);

<span class="cm">// Change content & style</span>
title.textContent = <span class="str">"New Title!"</span>;
title.style.color = <span class="str">"red"</span>;

<span class="cm">// Add event listener</span>
btn.<span class="fn">addEventListener</span>(<span class="str">"click"</span>, () => {
  <span class="fn">alert</span>(<span class="str">"Button clicked!"</span>);
});</div>
    `,
    challenge: 'Write JS to select an element with id "box" and change its background to blue.',
    answer: 'querySelector'
  }
];

// ---- LEVELS ----
const levels = [
  { name: 'Beginner', min: 0, max: 200 },
  { name: 'Novice', min: 200, max: 500 },
  { name: 'Developer', min: 500, max: 1000 },
  { name: 'Hacker', min: 1000, max: 2000 },
  { name: 'Engineer', min: 2000, max: 5000 },
  { name: 'Architect', min: 5000, max: Infinity },
];

function getLevel(xp) {
  for (let i = levels.length - 1; i >= 0; i--) {
    if (xp >= levels[i].min) return { level: i + 1, ...levels[i] };
  }
  return { level: 1, ...levels[0] };
}

// ---- RENDER ----
function renderCard(lesson, compact) {
  const done = state.completed.includes(lesson.id);
  return `
    <div class="lesson-card ${done ? 'completed' : ''}" onclick="openLesson(${lesson.id})">
      <div class="lesson-tag ${lesson.tagClass}">${lesson.tag.toUpperCase()}</div>
      <div class="lesson-title">${lesson.title}</div>
      <div class="lesson-desc">${lesson.desc}</div>
      <div class="lesson-footer">
        <div>
          <div class="lesson-xp">+${lesson.xp} XP</div>
          <div class="difficulty">${lesson.difficulty}</div>
        </div>
        <div class="lesson-status">${done ? '‚úÖ' : 'üìñ'}</div>
      </div>
    </div>
  `;
}

function renderLessons() {
  const homeEl = document.getElementById('home-lessons');
  const allEl = document.getElementById('all-lessons');
  const featured = lessons.slice(0, 4);
  homeEl.innerHTML = featured.map(l => renderCard(l)).join('');
  allEl.innerHTML = lessons.map(l => renderCard(l)).join('');
}

function updateUI() {
  const lvl = getLevel(state.xp);
  const nextLvl = levels[lvl.level - 1];
  const progress = nextLvl.max === Infinity ? 100 :
    ((state.xp - nextLvl.min) / (nextLvl.max - nextLvl.min)) * 100;

  document.getElementById('nav-xp').textContent = state.xp;
  document.getElementById('level-num').textContent = lvl.level;
  document.getElementById('level-name').textContent = lvl.name;
  document.getElementById('progress-xp').textContent = state.xp;
  document.getElementById('progress-max').textContent = nextLvl.max === Infinity ? '‚àû' : nextLvl.max;
  document.getElementById('progress-bar').style.width = Math.min(100, progress) + '%';
  document.getElementById('stat-xp').textContent = state.xp;
  document.getElementById('stat-level').textContent = lvl.level;
  document.getElementById('stat-completed').textContent = state.completed.length;
  document.getElementById('stat-streak').textContent = state.streak;

  // Profile hero
  const heroName = document.getElementById('profile-hero-username');
  const heroLevel = document.getElementById('profile-hero-level');
  if (heroName) {
    try {
      const session = JSON.parse(localStorage.getItem('codecraft-session') || '{}');
      heroName.textContent = session.username || 'You';
    } catch(e) { heroName.textContent = 'You'; }
  }
  if (heroLevel) heroLevel.textContent = `Level ${lvl.level} ¬∑ ${lvl.name}`;
  syncAvatarUI();

  // Gift banner
  if (state.giftClaimed) {
    document.getElementById('gift-banner').style.opacity = '0.4';
    document.getElementById('gift-banner').querySelector('.gift-text strong').textContent = 'Gift Claimed ‚úì';
    document.getElementById('gift-banner').querySelector('small').textContent = 'Come back tomorrow!';
  }

  // Completed list
  const cl = document.getElementById('completed-list');
  const doneLessons = lessons.filter(l => state.completed.includes(l.id));
  if (doneLessons.length > 0) {
    cl.innerHTML = doneLessons.map(l => `
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
        <span style="font-size:1.2rem">‚úÖ</span>
        <div>
          <div style="font-weight:700">${l.title}</div>
          <div style="font-size:0.8rem;color:var(--muted)">${l.xp} XP earned</div>
        </div>
      </div>
    `).join('');
  } else {
    cl.innerHTML = '<p style="color:var(--muted);font-size:0.9rem">No lessons completed yet. Start learning!</p>';
  }

  renderLessons();
  saveState();
}

// ---- SECTIONS ----
function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  if (event && event.target) event.target.classList.add('active');
  if (name === 'social') renderSocial();
}

// ---- LESSONS MODAL ----
let currentLesson = null;
function openLesson(id) {
  const lesson = lessons.find(l => l.id === id);
  currentLesson = lesson;
  document.getElementById('modal-tag').className = 'lesson-tag ' + lesson.tagClass;
  document.getElementById('modal-tag').textContent = lesson.tag.toUpperCase();
  document.getElementById('modal-title').textContent = lesson.title;
  document.getElementById('modal-xp-display').textContent = `‚ö° +${lesson.xp} XP reward`;

  const done = state.completed.includes(id);
  document.getElementById('modal-body').innerHTML = `
    <div class="lesson-content">${lesson.content}</div>
    <div class="challenge-box">
      <h4>üí° Challenge</h4>
      <p style="color:var(--muted);font-size:0.9rem">${lesson.challenge}</p>
      <textarea class="code-editor" id="challenge-input" placeholder="// Write your answer here..."></textarea>
      <div class="output-box" id="challenge-output"></div>
    </div>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="checkAnswer()">‚ñ∂ Check Answer</button>
      ${done ? '<button class="btn btn-secondary" onclick="closeModal()">Already Completed ‚úÖ</button>' : ''}
    </div>
  `;
  document.getElementById('lesson-modal').classList.add('open');
}

function checkAnswer() {
  const input = document.getElementById('challenge-input').value.trim();
  const output = document.getElementById('challenge-output');
  output.className = 'output-box visible';

  if (!input) {
    output.className = 'output-box visible error';
    output.textContent = '‚úó Please write some code first!';
    return;
  }

  if (input.toLowerCase().includes(currentLesson.answer)) {
    output.className = 'output-box visible';
    output.textContent = '‚úì Correct! Great work!';
    const alreadyDone = state.completed.includes(currentLesson.id);
    if (!alreadyDone) {
      state.completed.push(currentLesson.id);
      addXP(currentLesson.xp);
    }
    setTimeout(() => {
      if (!alreadyDone) showXPToast(currentLesson.xp);
      closeModal();
    }, 1200);
  } else {
    output.className = 'output-box visible error';
    output.textContent = `‚úó Not quite. Hint: make sure you include "${currentLesson.answer}" in your answer.`;
  }
}

function closeModal() {
  document.getElementById('lesson-modal').classList.remove('open');
  document.getElementById('gift-modal').classList.remove('open');
  updateUI();
}

// ---- GIFT ----
function openGift() {
  if (state.giftClaimed) return;
  document.getElementById('gift-xp-amount').textContent = `+${state.giftXP} XP`;
  document.getElementById('gift-modal').classList.add('open');
}

function claimGift() {
  state.giftClaimed = true;
  addXP(state.giftXP);
  showXPToast(state.giftXP);
  closeModal();
}

// ---- XP ----
function addXP(amount) {
  state.xp += amount;
  const newLevel = getLevel(state.xp);
  state.level = newLevel.level;
  updateUI();
}

function showXPToast(amount) {
  const toast = document.getElementById('xp-toast');
  document.getElementById('toast-amount').textContent = '+' + amount;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2800);
}

// ---- EDIT USERNAME ----
function startEditUsername() {
  const current = document.getElementById('profile-hero-username').textContent;
  document.getElementById('username-edit-input').value = current;
  document.getElementById('username-display-row').style.display = 'none';
  document.getElementById('username-edit-row').style.display = 'flex';
  document.getElementById('username-edit-input').focus();
  document.getElementById('username-edit-input').select();
}

function saveUsername() {
  const newName = document.getElementById('username-edit-input').value.trim();
  if (!newName || newName.length < 2) {
    document.getElementById('username-edit-input').style.borderColor = '#f87171';
    setTimeout(() => document.getElementById('username-edit-input').style.borderColor = 'var(--accent)', 1000);
    return;
  }
  // Update session
  try {
    const session = JSON.parse(localStorage.getItem('codecraft-session') || '{}');
    const accounts = JSON.parse(localStorage.getItem('codecraft-accounts') || '{}');
    // Update account record
    if (session.email && accounts[session.email]) {
      accounts[session.email].username = newName;
      localStorage.setItem('codecraft-accounts', JSON.stringify(accounts));
    }
    session.username = newName;
    localStorage.setItem('codecraft-session', JSON.stringify(session));
  } catch(e) {}
  // Update UI
  document.getElementById('profile-hero-username').textContent = newName;
  document.getElementById('nav-username').textContent = newName;
  cancelEditUsername();
  showXPToast(0, 'Username updated!');
}

function cancelEditUsername() {
  document.getElementById('username-display-row').style.display = 'flex';
  document.getElementById('username-edit-row').style.display = 'none';
}

// Allow Enter key to save
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('username-edit-row').style.display === 'flex') {
    saveUsername();
  }
  if (e.key === 'Escape' && document.getElementById('username-edit-row').style.display === 'flex') {
    cancelEditUsername();
  }
});

// ---- AVATAR PICKER ----
const AVATARS = {
  people: ['üßë‚Äçüíª','üë©‚Äçüíª','üßë‚Äçüéì','üë©‚Äçüéì','üßë‚Äçüî¨','üë©‚Äçüî¨','üßë‚Äçüé®','üë©‚Äçüé®','üßë‚ÄçüöÄ','üë©‚ÄçüöÄ','üßë‚Äçüîß','üë©‚Äçüîß','üßô','üßô‚Äç‚ôÄÔ∏è','ü•∑','ü¶∏','ü¶∏‚Äç‚ôÄÔ∏è','üßù','üßù‚Äç‚ôÄÔ∏è','ü§ñ'],
  tech:   ['üíª','üñ•Ô∏è','‚å®Ô∏è','üñ±Ô∏è','üì±','üíæ','üíø','üñ®Ô∏è','üîå','üîã','üì°','üõ∞Ô∏è','üî≠','‚öôÔ∏è','üî©','üßÆ','üìü','üïπÔ∏è','üëæ','üéÆ'],
  animals:['üê∂','üê±','ü¶ä','üê∫','ü¶Å','üêØ','üêª','üêº','üê®','ü¶ù','ü¶Ñ','üê≤','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶à','ü¶Ö','ü¶â','üêß'],
  misc:   ['üåü','‚≠ê','üí´','‚ú®','üî•','üí•','üåà','üéØ','üé≤','üèÜ','üé∏','üéµ','üçï','üçú','üßÉ','üöÄ','üåç','üíé','üëë','üé≠'],
};

// avatar can be an emoji string or a base64 data URL
let currentAvatar = 'üßë‚Äçüíª';
let currentAvatarIsPhoto = false;

try {
  const saved = localStorage.getItem('codecraft-avatar');
  if (saved) {
    currentAvatar = saved;
    currentAvatarIsPhoto = saved.startsWith('data:');
  }
} catch(e) {}

function openAvatarPicker() {
  // Render emoji grids
  Object.entries(AVATARS).forEach(([cat, emojis]) => {
    const grid = document.getElementById('avatar-grid-' + cat);
    if (!grid) return;
    grid.innerHTML = emojis.map(e => `
      <div class="avatar-option ${!currentAvatarIsPhoto && e === currentAvatar ? 'selected' : ''}" onclick="selectAvatar('${e}')">${e}</div>
    `).join('');
  });
  // Update upload preview
  refreshUploadPreview();
  document.getElementById('avatar-modal').classList.add('open');
}

function refreshUploadPreview() {
  const preview = document.getElementById('upload-preview');
  if (currentAvatarIsPhoto) {
    preview.innerHTML = `
      <img src="${currentAvatar}" alt="Your photo">
      <div class="uploaded-label">‚úì Photo uploaded</div>
      <div class="change-hint">Click to change photo</div>
    `;
    // Show remove button
    let removeBtn = document.getElementById('remove-photo-btn');
    if (!removeBtn) {
      removeBtn = document.createElement('button');
      removeBtn.id = 'remove-photo-btn';
      removeBtn.className = 'remove-photo-btn visible';
      removeBtn.textContent = '‚úï Remove Photo';
      removeBtn.onclick = (e) => { e.stopPropagation(); removePhoto(); };
      document.getElementById('upload-zone').after(removeBtn);
    } else {
      removeBtn.classList.add('visible');
    }
  } else {
    preview.innerHTML = `
      <div class="upload-icon">üì∑</div>
      <div class="upload-label">Click to upload a photo</div>
      <div class="upload-hint">JPG, PNG, GIF, WebP ¬∑ Max 5MB ¬∑ Drag & drop supported</div>
    `;
    const removeBtn = document.getElementById('remove-photo-btn');
    if (removeBtn) removeBtn.classList.remove('visible');
  }
}

function handleAvatarFile(file) {
  if (!file) return;
  if (!file.type.startsWith('image/')) {
    alert('Please upload an image file (JPG, PNG, GIF, or WebP).');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    alert('Image is too large. Please choose one under 5MB.');
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    // Resize/compress using canvas
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const size = 200;
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext('2d');
      // Crop to square from center
      const minSide = Math.min(img.width, img.height);
      const sx = (img.width - minSide) / 2;
      const sy = (img.height - minSide) / 2;
      ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size);
      const dataURL = canvas.toDataURL('image/jpeg', 0.85);
      setPhotoAvatar(dataURL);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function handleAvatarDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleAvatarFile(file);
}

function setPhotoAvatar(dataURL) {
  currentAvatar = dataURL;
  currentAvatarIsPhoto = true;
  try { localStorage.setItem('codecraft-avatar', dataURL); } catch(e) {}
  // Deselect all emoji options
  document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
  refreshUploadPreview();
  syncAvatarUI();
  setTimeout(() => closeAvatarPicker(), 400);
}

function removePhoto() {
  currentAvatar = 'üßë‚Äçüíª';
  currentAvatarIsPhoto = false;
  try { localStorage.setItem('codecraft-avatar', currentAvatar); } catch(e) {}
  refreshUploadPreview();
  syncAvatarUI();
  // Re-render emoji grids with selection
  Object.entries(AVATARS).forEach(([cat, emojis]) => {
    const grid = document.getElementById('avatar-grid-' + cat);
    if (!grid) return;
    grid.innerHTML = emojis.map(e => `
      <div class="avatar-option ${e === currentAvatar ? 'selected' : ''}" onclick="selectAvatar('${e}')">${e}</div>
    `).join('');
  });
}

function selectAvatar(emoji) {
  currentAvatar = emoji;
  currentAvatarIsPhoto = false;
  try { localStorage.setItem('codecraft-avatar', emoji); } catch(e) {}
  document.querySelectorAll('.avatar-option').forEach(el => {
    el.classList.toggle('selected', el.textContent.trim() === emoji);
  });
  refreshUploadPreview();
  syncAvatarUI();
  setTimeout(() => closeAvatarPicker(), 300);
}

function closeAvatarPicker() {
  document.getElementById('avatar-modal').classList.remove('open');
}

function syncAvatarUI() {
  // Profile page big avatar
  const el = document.getElementById('profile-avatar-emoji');
  if (el) {
    if (currentAvatarIsPhoto) {
      el.style.fontSize = '0';
      el.parentElement.style.backgroundImage = `url(${currentAvatar})`;
      el.parentElement.style.backgroundSize = 'cover';
      el.parentElement.style.backgroundPosition = 'center';
    } else {
      el.style.fontSize = '';
      el.textContent = currentAvatar;
      el.parentElement.style.backgroundImage = '';
    }
  }
  // Nav mini avatar
  const navEl = document.getElementById('nav-avatar');
  if (navEl) {
    if (currentAvatarIsPhoto) {
      navEl.innerHTML = `<img src="${currentAvatar}" style="width:22px;height:22px;border-radius:50%;object-fit:cover;vertical-align:middle">`;
    } else {
      navEl.textContent = currentAvatar;
    }
  }
}


function runCode() {
  const code = document.getElementById('main-editor').value;
  const lang = document.getElementById('lang-select').value;
  const output = document.getElementById('output-display');
  output.textContent = '';
  output.style.color = 'var(--success)';

  if (lang === 'js') {
    const logs = [];
    const fakeConsole = {
      log: (...args) => logs.push(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ')),
      error: (...args) => logs.push('ERROR: ' + args.join(' ')),
      warn: (...args) => logs.push('WARN: ' + args.join(' ')),
    };
    try {
      const fn = new Function('console', 'alert', code);
      fn(fakeConsole, (msg) => logs.push('[alert] ' + msg));
      output.textContent = logs.length > 0 ? logs.join('\n') : '// Code ran (no output)';
    } catch (err) {
      output.textContent = 'Error: ' + err.message;
      output.style.color = '#f87171';
    }
  } else {
    // HTML/CSS ‚Äî open in blob
    const blob = new Blob([code], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    output.innerHTML = `<iframe src="${url}" style="width:100%;height:360px;border:none;border-radius:8px;background:white"></iframe>`;
    output.style.color = 'var(--text)';
  }
}

function switchLang() {
  const lang = document.getElementById('lang-select').value;
  const hint = document.getElementById('lang-hint');
  const editor = document.getElementById('main-editor');
  if (lang === 'js') {
    hint.textContent = '// JavaScript mode';
    editor.placeholder = "// Write your code here...\n// Try: console.log('Hello, World!')";
  } else {
    hint.textContent = '<!-- HTML/CSS mode -->';
    editor.placeholder = '<!-- Write HTML here -->\n<h1 style="color:purple">Hello World!</h1>';
  }
  document.getElementById('output-display').textContent = '// Output will appear here...';
  document.getElementById('output-display').style.color = 'var(--success)';
}


// ---- MOCK USERS DATABASE ----
const mockUsers = [
  {
    id: 'u1', name: 'Linus Torvalds', handle: 'torvalds',
    avatar: 'üêß', color: '#f59e0b',
    xp: 99999, streak: 365,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Creator of the Linux kernel and Git. Started coding at 10 on a Commodore VIC-20. His open-source operating system now powers most of the internet and every Android phone.',
    known: 'Linux, Git',
    title: 'Father of Linux'
  },
  {
    id: 'u2', name: 'Ada Lovelace', handle: 'adalovelace',
    avatar: 'üëë', color: '#ec4899',
    xp: 88888, streak: 180,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Often regarded as the world\'s first computer programmer. In 1843 she wrote an algorithm for Charles Babbage\'s Analytical Engine ‚Äî over 100 years before modern computers existed.',
    known: 'First Algorithm',
    title: 'World\'s First Programmer'
  },
  {
    id: 'u3', name: 'Dennis Ritchie', handle: 'dmr',
    avatar: '¬©Ô∏è', color: '#06b6d4',
    xp: 97500, streak: 300,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Created the C programming language and co-developed Unix at Bell Labs. Without Dennis Ritchie, essentially no modern software would exist.',
    known: 'C Language, Unix',
    title: 'Creator of C'
  },
  {
    id: 'u4', name: 'Margaret Hamilton', handle: 'margaret_hamilton',
    avatar: 'üöÄ', color: '#10b981',
    xp: 94000, streak: 210,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Led the software team for NASA\'s Apollo missions. Her code landed humans on the Moon. She coined the term "software engineering."',
    known: 'Apollo 11 Software',
    title: 'Apollo Software Lead'
  },
  {
    id: 'u5', name: 'Guido van Rossum', handle: 'gvanrossum',
    avatar: 'üêç', color: '#3b82f6',
    xp: 91000, streak: 190,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Creator of Python, one of the most popular and beginner-friendly programming languages ever made. Started as a holiday project in 1989.',
    known: 'Python',
    title: 'Creator of Python'
  },
  {
    id: 'u6', name: 'Grace Hopper', handle: 'amazinggrace',
    avatar: '‚öì', color: '#8b5cf6',
    xp: 96000, streak: 365,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Rear Admiral and pioneering computer scientist. Invented the first compiler and helped develop COBOL. Popularized the term "debugging" after finding an actual moth in a relay.',
    known: 'First Compiler, COBOL',
    title: 'Mother of Computing'
  },
  {
    id: 'u7', name: 'Brendan Eich', handle: 'brendaneich',
    avatar: 'üåê', color: '#f97316',
    xp: 87000, streak: 155,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Created JavaScript in just 10 days in 1995 at Netscape. Now powers virtually every website on the planet. Co-founded Mozilla.',
    known: 'JavaScript',
    title: 'Creator of JavaScript'
  },
  {
    id: 'u8', name: 'Tim Berners-Lee', handle: 'timbl',
    avatar: 'üï∏Ô∏è', color: '#14b8a6',
    xp: 98000, streak: 280,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Invented the World Wide Web in 1989 at CERN. Created HTML, HTTP, and URLs. Gave it away for free to the world instead of patenting it.',
    known: 'World Wide Web, HTML',
    title: 'Inventor of the Web'
  },
  {
    id: 'u9', name: 'Bjarne Stroustrup', handle: 'bstroustrup',
    avatar: '‚öôÔ∏è', color: '#64748b',
    xp: 89000, streak: 170,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Created C++ in 1979. One of the most widely used programming languages in the world, powering everything from game engines to operating systems.',
    known: 'C++',
    title: 'Creator of C++'
  },
  {
    id: 'u10', name: 'Yukihiro Matsumoto', handle: 'matz',
    avatar: 'üíé', color: '#dc2626',
    xp: 82000, streak: 130,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Creator of Ruby, the language that inspired Rails and changed web development. Designed it to be programmer-friendly above all else: "I want Ruby to make programmers happy."',
    known: 'Ruby',
    title: 'Creator of Ruby'
  },
  {
    id: 'u11', name: 'James Gosling', handle: 'jamesgosling',
    avatar: '‚òï', color: '#854d0e',
    xp: 86000, streak: 145,
    completed: [1,2,3,4,5,6,7,8],
    bio: 'Father of Java, one of the most used programming languages in history. Invented at Sun Microsystems with the philosophy "write once, run anywhere."',
    known: 'Java',
    title: 'Father of Java'
  },
  {
    id: 'u12', name: 'John Carmack', handle: 'id_carmack',
    avatar: 'üéÆ', color: '#7c3aed',
    xp: 78000, streak: 90,
    completed: [1,2,3,4,5,6,7],
    bio: 'Legendary game programmer behind DOOM, Quake, and Wolfenstein 3D. Pioneered 3D graphics engines and revolutionized the video game industry. Later worked on VR at Oculus.',
    known: 'DOOM, Quake, 3D Engines',
    title: 'DOOM Creator'
  },
];

// Social state (separate from main state)
// Social state (separate from main state)
let socialState = {
  friends: [],
  pending: [],
  requests: [],
};

try {
  const saved = localStorage.getItem('codecraft-social');
  if (saved) {
    const parsed = JSON.parse(saved);
    socialState = { friends: parsed.friends || [], pending: parsed.pending || [], requests: parsed.requests || [] };
  }
} catch(e) { localStorage.removeItem('codecraft-social'); }

function saveSocial() {
  try { localStorage.setItem('codecraft-social', JSON.stringify(socialState)); } catch(e) {}
}

function getFriendStatus(uid) {
  if (socialState.friends.includes(uid)) return 'friends';
  if (socialState.pending.includes(uid)) return 'pending';
  if (socialState.requests.includes(uid)) return 'request';
  return 'none';
}

// ---- SEARCH ----
let searchTimeout = null;
function handleSearch(val) {
  clearTimeout(searchTimeout);
  const wrap = document.getElementById('search-results-wrap');
  if (!val.trim()) { wrap.style.display = 'none'; return; }
  searchTimeout = setTimeout(() => {
    const q = val.toLowerCase();
    const results = mockUsers.filter(u =>
      u.name.toLowerCase().includes(q) || u.handle.toLowerCase().includes(q)
    );
    wrap.style.display = 'block';
    const grid = document.getElementById('search-results-grid');
    if (results.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><span class="empty-icon">üîç</span>No users found for "${val}"</div>`;
    } else {
      grid.innerHTML = results.map(u => renderUserCard(u)).join('');
    }
  }, 200);
}

// ---- RENDER HELPERS ----
function levelName(xp) {
  const lvl = getLevel(xp);
  return `Lv.${lvl.level} ${lvl.name}`;
}

function renderUserCard(u) {
  const status = getFriendStatus(u.id);
  let btnHtml = '';
  if (status === 'friends') {
    btnHtml = `<button class="friend-btn friends" onclick="event.stopPropagation();unfriend('${u.id}')">‚úì Friends</button>`;
  } else if (status === 'pending') {
    btnHtml = `<button class="friend-btn pending">‚è≥ Pending</button>`;
  } else if (status === 'request') {
    btnHtml = `<button class="friend-btn add" onclick="event.stopPropagation();acceptRequest('${u.id}')">Accept ‚Üí</button>`;
  } else {
    btnHtml = `<button class="friend-btn add" onclick="event.stopPropagation();sendRequest('${u.id}')">+ Add</button>`;
  }
  return `
    <div class="user-card" onclick="openUserProfile('${u.id}')">
      <div class="avatar" style="background:${u.color}22;border-color:${u.color}44">${u.avatar}</div>
      <div class="user-info">
        <div class="user-name">${u.name}</div>
        <div class="user-meta" style="color:${u.color};font-weight:600;font-size:0.78rem">${u.title || '@' + u.handle}</div>
        <div class="user-xp-badge">‚ö° ${u.xp.toLocaleString()} XP</div>
      </div>
      ${btnHtml}
    </div>`;
}

// ---- FRIEND ACTIONS ----
function sendRequest(uid) {
  socialState.pending.push(uid);
  saveSocial();
  renderSocial();
  handleSearch(document.getElementById('user-search').value);
  showXPToast(0, `Request sent to @${mockUsers.find(u=>u.id===uid).handle}!`);
}

function unfriend(uid) {
  socialState.friends = socialState.friends.filter(id => id !== uid);
  saveSocial();
  renderSocial();
  handleSearch(document.getElementById('user-search').value);
}

function acceptRequest(uid) {
  socialState.requests = socialState.requests.filter(id => id !== uid);
  socialState.friends.push(uid);
  saveSocial();
  renderSocial();
  handleSearch(document.getElementById('user-search').value);
}

function declineRequest(uid) {
  socialState.requests = socialState.requests.filter(id => id !== uid);
  saveSocial();
  renderSocial();
}

// ---- RENDER SOCIAL ----
function renderSocial() {
  // Friend notif dot in nav
  const hasReqs = socialState.requests.length > 0;
  document.getElementById('friend-notif').style.display = hasReqs ? 'inline-block' : 'none';

  // Request badge
  const badge = document.getElementById('req-count-badge');
  if (socialState.requests.length > 0) {
    badge.style.display = 'inline';
    badge.textContent = socialState.requests.length;
  } else {
    badge.style.display = 'none';
  }

  // Friends list
  const friendsEl = document.getElementById('friends-list-container');
  const friends = mockUsers.filter(u => socialState.friends.includes(u.id));
  if (friends.length === 0) {
    friendsEl.innerHTML = `<div class="empty-state"><span class="empty-icon">üë•</span>No friends yet. Search for users above!</div>`;
  } else {
    friendsEl.innerHTML = `<div class="search-results">${friends.map(u => renderUserCard(u)).join('')}</div>`;
  }

  // Requests list
  const reqEl = document.getElementById('requests-container');
  const reqs = mockUsers.filter(u => socialState.requests.includes(u.id));
  if (reqs.length === 0) {
    reqEl.innerHTML = `<div class="empty-state"><span class="empty-icon">üì¨</span>No pending friend requests.</div>`;
  } else {
    reqEl.innerHTML = `<div class="friend-requests-list">${reqs.map(u => `
      <div class="request-card">
        <div class="avatar" style="background:${u.color}22;border-color:${u.color}44;width:44px;height:44px;font-size:1.3rem">${u.avatar}</div>
        <div class="user-info">
          <div class="user-name">${u.name}</div>
          <div class="user-meta">@${u.handle} ¬∑ ‚ö° ${u.xp} XP</div>
        </div>
        <div class="request-actions">
          <button class="req-accept" onclick="acceptRequest('${u.id}')">Accept</button>
          <button class="req-decline" onclick="declineRequest('${u.id}')">Decline</button>
        </div>
      </div>`).join('')}</div>`;
  }

}

// ---- SOCIAL TABS ----
function switchSocialTab(tab, btn) {
  document.querySelectorAll('.social-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.social-tab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

function showSection2(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => {
    if (t.textContent.toLowerCase().includes(name)) t.classList.add('active');
  });
}

// ---- USER PROFILE MODAL ----
let viewingUserId = null;
function openUserProfile(uid) {
  const u = mockUsers.find(u => u.id === uid);
  if (!u) return;
  viewingUserId = uid;
  const lvl = getLevel(u.xp);
  document.getElementById('upm-avatar').textContent = u.avatar;
  document.getElementById('upm-avatar').style.background = u.color + '22';
  document.getElementById('upm-avatar').style.borderColor = u.color + '55';
  document.getElementById('upm-name').textContent = u.name;
  document.getElementById('upm-handle').innerHTML = `@${u.handle} &nbsp;¬∑&nbsp; <span style="color:${u.color};font-weight:700">${u.title || ''}</span>`;
  document.getElementById('upm-xp').textContent = u.xp.toLocaleString();
  document.getElementById('upm-level').textContent = lvl.level;
  document.getElementById('upm-lessons').textContent = u.completed.length;
  document.getElementById('upm-streak').textContent = u.streak;

  // Friend action button
  const status = getFriendStatus(uid);
  let actionHtml = '';
  if (status === 'friends') {
    actionHtml = `<button class="btn btn-secondary" onclick="unfriend('${uid}');updateUserModal('${uid}')" style="border-color:rgba(239,68,68,0.3);color:#f87171">Remove Friend</button>`;
  } else if (status === 'pending') {
    actionHtml = `<button class="btn btn-secondary" style="cursor:default;opacity:0.7">‚è≥ Request Pending</button>`;
  } else if (status === 'request') {
    actionHtml = `<button class="btn btn-success" onclick="acceptRequest('${uid}');updateUserModal('${uid}')">‚úì Accept Request</button>`;
  } else {
    actionHtml = `<button class="btn btn-primary" onclick="sendRequest('${uid}');updateUserModal('${uid}')">+ Add Friend</button>`;
  }
  document.getElementById('upm-friend-action').innerHTML = actionHtml;

  // Bio + known for
  const lessonsEl = document.getElementById('upm-lessons-list');
  const done = u.completed.map(lid => lessons.find(l => l.id === lid)).filter(Boolean);
  lessonsEl.innerHTML = `
    ${u.bio ? `<p style="color:var(--muted);font-size:0.88rem;line-height:1.65;margin-bottom:16px">${u.bio}</p>` : ''}
    ${u.known ? `<div style="margin-bottom:16px"><span style="font-size:0.72rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted)">Known For</span><br><span style="color:${u.color};font-weight:700;font-size:0.95rem">${u.known}</span></div>` : ''}
    <div class="profile-lessons-title" style="margin-top:8px">Lessons Completed</div>
    ${done.length === 0
      ? `<p style="color:var(--muted);font-size:0.85rem">No lessons completed yet.</p>`
      : done.map(l => `<span class="profile-lesson-badge"><span class="lesson-tag ${l.tagClass}" style="margin:0;font-size:0.65rem;padding:1px 6px">${l.tag.toUpperCase()}</span>${l.title}</span>`).join('')
    }
  `;

  document.getElementById('user-profile-modal').classList.add('open');
}

function updateUserModal(uid) {
  renderSocial();
  openUserProfile(uid);
}

function closeUserModal() {
  document.getElementById('user-profile-modal').classList.remove('open');
}

// Override showXPToast to handle optional message
const _origShowXPToast = showXPToast;
window.showXPToast = function(amount, msg) {
  const toast = document.getElementById('xp-toast');
  if (msg) {
    toast.innerHTML = `üí¨ ${msg}`;
  } else {
    toast.innerHTML = `‚ö° <span>+${amount}</span> XP!`;
  }
  toast.classList.add('show');
  setTimeout(() => { toast.classList.remove('show'); toast.innerHTML = `‚ö° <span id="toast-amount"></span> XP!`; }, 2800);
};


document.addEventListener('DOMContentLoaded', () => {
  const editor = document.getElementById('main-editor');
  if (editor) {
    editor.addEventListener('keydown', e => {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = editor.selectionStart, end = editor.selectionEnd;
        editor.value = editor.value.substring(0, start) + '  ' + editor.value.substring(end);
        editor.selectionStart = editor.selectionEnd = start + 2;
      }
    });
  }
}, { once: false });
</script>
</body>
</html>
